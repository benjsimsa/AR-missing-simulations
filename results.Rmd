---
title: "Results"
output:
  pdf_document: default
  word_document: default
bibliography: references.bib
---

```{r message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
# import packages
library(tidyverse)
library(report)
library(kableExtra)
library(knitr)
library(here)
library(papaja)
library(pander)
library(effectsize)
library(gridExtra)
library(ggpubr)
```

```{r  cache = TRUE, message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
# prepare the dataset for MSE 

rdslist = list.files(path = here::here("results", "sim_a_norandomslopes"), pattern='*.rds') # put all the data files with results in a list


anova_bias_df = data.frame(matrix(ncol = 7))
colnames(anova_bias_df) = c("B1_bias", "B1_sim", "N", "T.obs", "miss_type", "compliance", "model_observations")
                  
for (i in 1:length(rdslist)){ # for-loop that connects all files from rdslist into one file 
  res = readRDS(here::here("results", "sim_a_norandomslopes", rdslist[i]))
  B1_bias = res$beta.hat.lme.list[, 2] - res$b10
  B1_sim = res$b10
  N = res$N
  T.obs = res$T.obs
  miss_type = res$missing_type
  compliance = res$comp_mean 
  model_observations = res$model_observations
  results = data.frame(B1_bias, B1_sim, N, T.obs, miss_type, compliance, model_observations)
  
  anova_bias_df = rbind(anova_bias_df, results)
}

# for some reason, the first row is only NAs, remove it: 
anova_bias_df = anova_bias_df[-1, ]
```

# Results

## Simulation A

The descriptive results for all 288 conditions included in Simulation A are reported in the appendix (TODO).

### Outcome: Estimation bias (MSE)

```{r  echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}

anova_bias = lm(formula = B1_bias ~ N + T.obs + miss_type + compliance + B1_sim + N:T.obs + N:miss_type + T.obs:miss_type + N:compliance + T.obs:compliance + miss_type:compliance + N:B1_sim + T.obs:B1_sim + miss_type:B1_sim + compliance:B1_sim, data = anova_bias_df, type = 1)


omegasq_bias = data.frame(omega_squared(anova_bias, partial = TRUE)) %>%
  select(Omega2_partial) %>%
  rename("Partial omega-squared" = "Omega2_partial")
omegasq_bias[16, ] = NA # add omega-squared of 0 for residuals

anova_table = as.data.frame(anova(anova_bias))

# Kable reports extremely small p-values as 0.000, while APA-7 requires them to be reported as <.001 . Let's transform the dataframe


anova_table = cbind(anova_table, omegasq_bias) %>% 
  rename("p-value" = "Pr(>F)") 

anova_table$`p-value` = format.pval(anova_table$`p-value`, digits = 2, eps = .001)
```

**ANOVA.** We used a 4 × 2 × 3 × 4 × 3 factorial Type I ANOVA (with estimation bias as an outcome and number of participants, number of timepoints per participant, missingness type, compliance, and the simulated fixed autoregressive effect) to assess which of the manipulated factors had a considerable influence on estimation bias. The results from every simulation run (i. e., 1,000 results per condition = 288,000 rows) were combined into a single dataset for the analysis. Given the very large sample size (which would make any difference significant) and the exploratory character of the analysis, *p*-values and significance thresholds were not used make inferences. Instead, we used a threshold of 0.14 for the partial $\omega^2$, indicating a large effect size [@field2012discovering]. This cutoff will be used for all ANOVA results throughout the results section. The partial $\omega^2$ was chosen as the less biased alternative to partial $\eta^2$ [@okada2013omega]. The results and effect sizes are reported in Table \ref{tab:table_anova_bias}.

Four main effects above the effect size threshold of 0.14 were found: the main effect of missingness type ($\omega^{2}$ = `r round(anova_table[3, 6], 2)`), compliance ($\omega^{2}_p$ = `r round(anova_table[4, 6], 2)`), the number of timepoints per participant ($\omega^{2}_p$ = `r round(anova_table[2, 6], 2)`), and the simulated fixed slope ($\omega^{2}_p$ = `r round(anova_table[5, 6], 2)`). Furthermore, the interaction between the missingness type and compliance ($\omega^{2}_p$ = `r round(anova_table[11, 6], 2)`) had an effect size above the cut-off.

The main effects of missingness type and compliance are visualised in Figure \ref{fig:fig_prec_type} and Figure \ref{fig:fig_prec_comp} (respectively), while the interaction between missingness type and compliance are depicted in Figure \ref{fig:fig_prec_interaction}.

```{r fig_prec_type, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, fig.cap = "\\label{fig:fig_prec_type}The effect of compliance on the bias in estimation of the fixed slopes.", fig.width=6.4, fig.height=3.4}

library(ggdist)
# set a colorblind-friendly color pallete 
cbPalette = c("#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7", "#000000")

cbPalette_other = c("#0072B2", "#D55E00", "#CC79A7", "#000000")



(boxplot_precision_type = anova_bias_df %>% 
  ggplot(aes(x = as.factor(miss_type), y = B1_bias, fill = as.factor(miss_type), group = as.factor(miss_type))) + 
  stat_halfeye(justification = -0.2, alpha = 0.7, outlier.size = 1) + 
  geom_boxplot(width = 0.3, alpha = 0.9) + 
  theme_apa() + 
  scale_fill_manual(values = cbPalette) + 
  ylab("Bias in estimation of fixed AR effect") + 
  xlab("Missingness type") + 
  theme(legend.position = "none") + 
  geom_hline(yintercept = 0, linetype = "dashed") + 
  theme(axis.text.x = element_text(size = 10))
  )
```

Figure \ref{fig:fig_prec_type} shows that while the underestimation of the fixed slopes is fairly low (although still considerable) when the observations are missing completely at random or in block, it becomes severe when only the most extreme values (both at one side and at both sides) are missing. SOMETHING ABOUT JANNE'S PAPER! Additionally, the underestimation of the fixed slopes becomes more severe as the compliance gets lower.

The average estimation bias when compliance is 0.8 (which is very close to the average compliance of ESM studies in psychology) is `r round(mean(anova_bias_df$B1_bias[anova_bias_df$compliance == 0.8]), 2)`. As a consequence, many estimates of inertia in psychological research could be seriously downward biased. Furthermore, the estimates are slightly biased even when compliance is 1 (i. e., there are no missing data; average bias: `r round(mean(anova_bias_df$B1_bias[anova_bias_df$compliance == 1]), 2)`). This is in line with the findings about estimation biased caused by person-mean centering in multilevel autoregressive models [@hamaker2015].

Zooming in on the interaction between compliance and missingness type (Figure \ref{fig:fig_prec_interaction}) suggests that the effect of compliance on estimation bias is dramatically more severe for the two conditions in which the most extreme values of the process were set as missing (as compared to the other two conditions, i. e., data MCAR and missing in blocks). In the worst-case scenario (low compliance of 0.4; the most extreme values at both sides missing), the average estimation bias was `r round(mean(anova_bias_df$B1_bias[anova_bias_df$compliance == 0.4 & anova_bias_df$miss_type == "extreme_twosided"]), 2)`). Given that the average simulated fixed slope was 0.5, these results imply that even rather large autocorrelations can be estimated as close to 0 in studies with the combination of low compliance and a non-random missingness pattern. At the same time, the results about data MCAR and missing in blocks are encouraging. Even in a low-compliance (0.4) condition, the average estimation bias was `r round(mean(anova_bias_df$B1_bias[anova_bias_df$compliance == 0.4 & anova_bias_df$miss_type == "mcar"]), 2)` for the former and `r round(mean(anova_bias_df$B1_bias[anova_bias_df$compliance == 0.4 & anova_bias_df$miss_type == "block"]), 2)` for the latter.

The average estimation bias for all combinations of missingness type and compliance (averaged over the different values of the number of participants, timepoints per participant and simulated fixed slope) is reported in Table \ref{tab:table_bias}.

```{r fig_prec_comp, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, fig.cap = "\\label{fig:fig_prec_comp}The effect of missingness type on the bias in estimation of the fixed slopes.", fig.width=6.4, fig.height=3.4}
(boxplot_precision_compliance = anova_bias_df %>% 
  ggplot(aes(x = as.factor(compliance), y = B1_bias, fill = as.factor(compliance), group = as.factor(compliance))) + 
  stat_halfeye(justification = -0.2, alpha = 0.7, outlier.size = 1) + 
  geom_boxplot(width = 0.3, alpha = 0.9) +
  theme_apa() + 
  scale_fill_manual(values = cbPalette_other) + 
  ylab("Bias in estimation of fixed AR effect") + 
  xlab("Compliance") + 
  theme(legend.position = "none") + 
  geom_hline(yintercept = 0, linetype = "dashed")
  )
```

```{r fig_prec_interaction, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, fig.cap = "\\label{fig:fig_prec_interaction}The effect of the interaction between missingness type and compliance on the bias in estimation of the fixed slopes.", fig.width=6.4, fig.height=3.4}
(boxplot_precision_compliance_misstype = anova_bias_df %>% 
  ggplot(aes(x = as.factor(compliance), y = B1_bias, fill = as.factor(miss_type))) + 
  geom_boxplot(width = 0.8, alpha = 0.8, outlier.size = 1) +
  theme_apa() + 
  scale_fill_manual(values = cbPalette) + 
  ylab("Bias in estimation of fixed AR effect") + 
  xlab("Compliance") + 
  labs(fill='Missingness type') +
  geom_hline(yintercept = 0, linetype = "dashed"))
```

```{r table_anova_bias, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
options(knitr.kable.NA = '')

(anova_table, 
      format = "latex", 
      booktabs = TRUE,  
      digits = 2,
      caption = "ANOVA results, simulation A. Outcome: Estimation bias") %>% 
  kable_styling(full_width = F)

```

```{r table_bias, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
library(reshape2)
table_bias = anova_bias_df %>% 
  group_by(miss_type, compliance) %>% 
  summarise(round(mean(B1_bias),2)) %>% 
  rename("bias" = "round(mean(B1_bias), 2)") %>% 
  dcast(compliance ~ miss_type, value.var = "bias")



kable(table_bias, 
      format = "latex", 
      booktabs = TRUE,  
      digits = 2,
      caption = "Simulation A. Average bias in estimation of the fixed slope for each combination of missingness type and compliance.") %>% 
  kable_styling(full_width = F) %>% 
  add_header_above(c(" " = 1, "Missingness type" = 4)) %>% 
  column_spec(1, border_right = TRUE)
```

### Outcome: Standard error

```{r cache = TRUE, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}

# create dataframe with overall results from each condition (i.e., 288 rows instead of 288,000)

  
overall_df = data.frame(matrix(ncol = 15)) # prepare the data frame 
names = c("B0_est",
          "B1_est",
          "B0_pow",
          "B1_pow",
          "B0_se",
          "B1_se",
          "conv",
          "N",
          "T.obs",
          "compliance",
          "miss_type",
          "bias_mean",
          "model_observations",
          "B1_sim",
          "B1_bias")
colnames(overall_df) = names



for (i in length(rdslist):1){ # for-loop that connects all files from rdslist into one file 
  res = readRDS(here::here("results", "sim_a_norandomslopes", rdslist[i]))
  overall_df[i, 1] = as.numeric(res$beta.hat.lme[1])
  overall_df[i, 2] = as.numeric(res$beta.hat.lme[2])
  overall_df[i, 3] = as.numeric(res$power.hat.lme[1])
  overall_df[i, 4] = as.numeric(res$power.hat.lme[2])
  overall_df[i, 5] = as.numeric(res$StdError.beta.hat.lme[1])
  overall_df[i, 6] = as.numeric(res$StdError.beta.hat.lme[2])
  overall_df[i, 7] = as.numeric(res$n.R)
  overall_df[i, 8] = as.numeric(res$N)
  overall_df[i, 9] = as.numeric(res$T.obs)
  overall_df[i, 10] = as.numeric(res$comp_mean)
  overall_df[i, 11] = (res$missing_type)
  overall_df[i, 12] = as.numeric(res$bias_mean)
  overall_df[i, 13] = as.numeric(res$model_observations)
  overall_df[i, 14] = as.numeric(res$b10)
  overall_df[i, 15] = as.numeric(res$beta.hat.lme[2] - res$b10)
}

```

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}

anova_se = lm(formula = B1_se ~ N + T.obs + miss_type + compliance + B1_sim + N:T.obs + N:miss_type + T.obs:miss_type + N:compliance + T.obs:compliance + miss_type:compliance + N:B1_sim + T.obs:B1_sim + miss_type:B1_sim + compliance:B1_sim, data = overall_df, type = 1)


omegasq_se = data.frame(omega_squared(anova_se, partial = TRUE)) %>%
  select(Omega2_partial) %>%
  rename("Partial omega-squared" = "Omega2_partial")
omegasq_se[16, ] = NA # add omega-squared of 0 for residuals

anova_table_se = as.data.frame(anova(anova_se))

# Kable reports extremely small p-values as 0.000, while APA-7 requires them to be reported as <.001 . Let's transform the dataframe


anova_table_se = cbind(anova_table_se, omegasq_se) %>% 
  rename("p-value" = "Pr(>F)") 

anova_table_se$`p-value` = format.pval(anova_table_se$`p-value`, digits = 2, eps = .001)

options(knitr.kable.NA = '')

```

**Descriptive statistics.** The average standard errors for the different combinations of number of participants, timepoints per participant and compliance are reported in Table \\ref{tab:tab_aov_se}.

```{r tab_aov_se, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}

table_xc = overall_df %>% 
  group_by(N, T.obs, compliance) %>% 
  summarise(round(mean(B1_se), 2)) %>% 
  rename("SE" = "round(mean(B1_se), 2)") %>% 
  dcast(N + T.obs ~ compliance, value.var = "SE")


kable(table_xc, 
      format = "latex", 
      booktabs = TRUE,  
      digits = 2,
      caption = "Simulation A. Average standard error in the estimation of the fixed slope for each combination of number of participants, number of timepoints/participant, and compliance.") %>% 
  kable_styling(full_width = F) %>% 
  add_header_above(c(" " = 2, "Compliance" = 4)) %>% 
  column_spec(3, border_left = TRUE) %>% 
  collapse_rows(columns = 1)
```

**ANOVA.** To examine the effect of the manipulated parameters on the standard error of the estimation of the fixed slopes, we combined the results for each condition (1,000 simulation runs) into a single row. As such, the dataset used for the following analyses had one row per simulation condition (288 rows in total). A a 4 × 2 × 3 × 4 × 3 factorial Type I ANOVA was used to analyse the data. The full ANOVA results and effect sizes are reported in Table DS.

The main effects of the number of participants ($\omega^{2}_p$ = `r round(anova_table_se[1, 6], 2)`), number of timepoints per participant ($\omega^{2}_p$ = `r round(anova_table_se[2, 6], 2)`) and compliance ($\omega^{2}_p$ = `r round(anova_table_se[4, 6], 2)`) crossed the cut-off for effect size.

Additionally, the interaction between the number of timepoints per participant and compliance ($\omega^{2}_p$ = `r round(anova_table_se[10, 6], 2)`), number of participants and timepoints per participants ($\omega^{2}_p$ = `r round(anova_table_se[5, 6], 2)`), and between the number of participants and compliance ($\omega^{2}_p$ = `r round(anova_table_se[9, 6], 2)`) was found.

Figure \ref{fig:fig_se_interaction} depicts the interaction between the number of timepoints per participant and compliance, while Figure \ref{fig:fig_se_compliance} shows the interaction between the number of participants and compliance.

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}

# table XC

kable(anova_table_se, 
      format = "latex", 
      booktabs = TRUE,  
      digits = 2,
      caption = "ANOVA results, simulation A. Outcome: Standard error") %>% 
  kable_styling(full_width = F)

```

```{r fig_se_interaction, echo=FALSE, fig.height=3.4, fig.width=6.4, message=FALSE, warning=FALSE, paged.print=FALSE, fig.cap = "\\label{fig:fig_se_interaction}The effect of the interaction between number of timepoints and compliance on standard error of estimation of the fixed slopes. Simulation A."}
# Figure AD 
(figure_ad = overall_df %>% 
  ggplot(aes(x = as.factor(compliance), y = B1_se, fill = as.factor(T.obs))) + 
  geom_boxplot(width = 0.7, alpha = 0.9, outlier.size = 1) +
  theme_apa() + 
  scale_fill_manual(values = cbPalette_other) + 
  ylab("Standard error") + 
  xlab("Compliance") + 
  geom_hline(yintercept = 0, linetype = "dashed")) + 
  labs(fill = "Timepoints per participant")
```

```{r fig_se_compliance, echo=FALSE, fig.height=3.4, fig.width=6.4, message=FALSE, warning=FALSE, paged.print=FALSE, fig.cap = "\\label{fig:fig_se_compliance}The effect of the interaction between number of participants and compliance on standard error of estimation of the fixed slopes. Simulation A."}
# Figure AF 
(figure_af = overall_df %>% 
  ggplot(aes(x = as.factor(compliance), y = B1_se, fill = as.factor(N))) + 
  geom_boxplot(width = 0.7, alpha = 0.9, outlier.size = 1) +
  theme_apa() + 
  scale_fill_manual(values = cbPalette_other) + 
  ylab("Standard error") + 
  xlab("Compliance") + 
  geom_hline(yintercept = 0, linetype = "dashed")) + 
  labs(fill = "Number of participants")
```

**Bias in the estimation of the fixed slope and bias in the estimation of the person-specific means.** TODO.

### Outcome: Statistical power

**Descriptive statistics.** The statistical power for each combination of the manupulated parameters is reported in Table (BIG TABLE TODO). As an illustration, the effect of compliance, missingness type, the number of participants and the number of timepoints per participant when the simulated fixed slope is 0.3 are visualised in Figure \ref{fig:fig_power}. Consistent with the results about estimation bias, statistical power is the lowest in the two conditions with the most extreme datapoints missing. For the conditions with data missing completely at random and data missing in consecutive blocks, power is very high even when the compliance is low for most conditions (except for the two conditions with T = 20).

A peculiar pattern is worth pointing out in the plot: in the two conditions with T = 20 and the most extreme data missing at both sides (green dashed line), the statistical power is higher when compliance is 0.4 compared to when compliance is 0.6. This counterintuitive result is likely due to the fact that the underestimation is the most severe when the most extreme values at both sides. As such, some of the estimates of the fixed slope will be negative, and their magnitude will be large enough for them to reach statistical significance.

```{r message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}

viz_NT_pow = function(B1 = 0.3, N_select, T.obs_select, data = overall_df, x_axis){
  # Get subset of the data that has the particulaR N/T combination 
  d = data %>% 
   filter(data$N == N_select & data$T.obs == T.obs_select & data$B1_sim == B1)

  d$miss_type = as.factor(d$miss_type)
  
  # Visualise the data
  pow_avg = ggplot( data = d,
                        mapping = aes(x = compliance,
                                      y = B1_pow, 
                                      group = miss_type)) +
                  geom_line(aes(linetype = miss_type,
                                  colour = miss_type)) + 
                  theme_apa() +
                  geom_point(aes(colour = miss_type)) +
                  scale_x_continuous(breaks = c(0.4, 0.6, 0.8, 1)) +
                  theme(axis.title.x = element_blank(),
                        axis.title.y = element_blank(),
                        legend.position = "none") + 
                  ylim(0, 1)

  
  return(pow_avg)
}

# figure VC
Ns = c(20, 100)
Ts = c(20, 50, 100)
B1= 0.3
plotlist = list()


pwr_03_20_20 = ggplot(data = filter(overall_df, N == 20, T.obs == 20, B1_sim == 0.3), 
                        mapping = aes(x = compliance,
                                      y = B1_pow, 
                                      group = miss_type)) +
                  geom_line(aes(linetype = miss_type,
                                  colour = miss_type)) + 
                  theme_apa() +
                  scale_color_manual(values = cbPalette) + 
  
                  geom_point(aes(colour = miss_type)) +
                  scale_x_continuous(breaks = c(0.4, 0.6, 0.8, 1)) +
                  theme(axis.title.x = element_blank(), 
                        axis.title.y = element_blank(),
                        legend.position = "none") + 
                  ylim(0, 1) + 
                  annotate("text", x = 0.8, y = 0.05, label = "N=20, T=20", size = 5)

pwr_03_20_50 = ggplot( data = filter(overall_df, N == 20, T.obs == 50, B1_sim == 0.3), 
                        mapping = aes(x = compliance,
                                      y = B1_pow, 
                                      group = miss_type)) +
                  geom_line(aes(linetype = miss_type,
                                  colour = miss_type)) + 
                  theme_apa() +
                  scale_color_manual(values = cbPalette) + 
                  geom_point(aes(colour = miss_type)) +
                  scale_x_continuous(breaks = c(0.4, 0.6, 0.8, 1)) + 
                  theme(axis.title.x = element_blank(), 
                        axis.title.y = element_blank(),
                        legend.position = "none",
                        legend.title = element_text("Missingness type")) + 
                  ylim(0, 1) + 
                  annotate("text", x = 0.8, y = 0.05, label = "N=20, T=50", size = 5)

pwr_03_20_100 = ggplot( data = filter(overall_df, N == 20, T.obs == 100, B1_sim == 0.3), 
                        mapping = aes(x = compliance,
                                      y = B1_pow, 
                                      group = miss_type)) +
                  geom_line(aes(linetype = miss_type,
                                  colour = miss_type)) + 
                  scale_color_manual(values = cbPalette) + 
                  theme_apa() +
                  geom_point(aes(colour = miss_type)) +
                  scale_x_continuous(breaks = c(0.4, 0.6, 0.8, 1)) + 
                  theme(axis.title.x = element_blank(), 
                        axis.title.y = element_blank(),
                        legend.position = "none",
                        legend.title = element_text("Missingness type")) + 
                  ylim(0, 1) +
                  annotate("text", x = 0.8, y = 0.05, label = "N=20, T=100", size = 5)

pwr_03_100_20 = ggplot( data = filter(overall_df, N == 100, T.obs == 20, B1_sim == 0.3), 
                        mapping = aes(x = compliance,
                                      y = B1_pow, 
                                      group = miss_type)) +
                  geom_line(aes(linetype = miss_type,
                                  colour = miss_type)) + 
                  theme_apa() +
                  scale_color_manual(values = cbPalette) + 
                  geom_point(aes(colour = miss_type)) +
                  scale_x_continuous(breaks = c(0.4, 0.6, 0.8, 1)) +
                  theme(axis.title.x = element_blank(), 
                        axis.title.y = element_blank(),
                      legend.position = "none") + 
                  ylim(0, 1) + 
                  annotate("text", x = 0.8, y = 0.05, label = "N=100, T=20", size = 5)

pwr_03_100_50 = ggplot( data = filter(overall_df, N == 100, T.obs == 50, B1_sim == 0.3), 
                        mapping = aes(x = compliance,
                                      y = B1_pow, 
                                      group = miss_type)) +
                  geom_line(aes(linetype = miss_type,
                                  colour = miss_type)) + 
                  theme_apa() +
                  scale_color_manual(values = cbPalette) + 
                  geom_point(aes(colour = miss_type)) +
                  scale_x_continuous(breaks = c(0.4, 0.6, 0.8, 1))  +
                  theme(axis.title.x = element_blank(), 
                        axis.title.y = element_blank(),
                        legend.position = "none",
                        legend.title = element_text("Missingness type")) + 
                  ylim(0, 1) + 
                  annotate("text", x = 0.8, y = 0.05, label = "N=100, T=50", size = 5)

pwr_03_100_100 = ggplot( data = filter(overall_df, N == 100, T.obs == 100, B1_sim == 0.3), 
                        mapping = aes(x = compliance,
                                      y = B1_pow, 
                                      group = miss_type)) +
                  geom_line(aes(linetype = miss_type,
                                  colour = miss_type)) + 
                  theme_apa() +
                  scale_color_manual(values = cbPalette) + 
                  geom_point(aes(colour = miss_type)) +
                  scale_x_continuous(breaks = c(0.4, 0.6, 0.8, 1))  +
                  theme(axis.title.x = element_blank(), 
                        axis.title.y = element_blank(),
                        legend.position = "none") + 
                  ylim(0, 1) + 
                  annotate("text", x = 0.8, y = 0.05, label = "N=100, T=100", size = 5)

pwr_03_arranged = ggarrange(pwr_03_20_20, pwr_03_20_50,pwr_03_20_100,
                            pwr_03_100_20, pwr_03_100_50, pwr_03_100_100,
                            common.legend = TRUE)

```

```{r fig_power, fig.cap = "\\label{fig:fig_power}Simulation A. Statistical power to detect the fixed slope for all combinations of compliance, missingness type, number of participants and timepoints per participant when the simulated fixed slope is 0.3.", echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, fig.width = 8, fig.height = 5}

(pwr_03_arranged_annotated = annotate_figure(pwr_03_arranged,
                bottom = text_grob("Compliance"),
                left = text_grob("Power to detect the fixed AR effect", rot = 90)))

```

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}

anova_pwr = lm(formula = B1_pow ~ N + T.obs + miss_type + compliance + B1_sim + N:T.obs + N:miss_type + T.obs:miss_type + N:compliance + T.obs:compliance + miss_type:compliance + N:B1_sim + T.obs:B1_sim + miss_type:B1_sim + compliance:B1_sim, data = overall_df, type = 1)

omegasq_pwr = data.frame(omega_squared(anova_pwr, partial = TRUE)) %>%
  select(Omega2_partial) %>%
  rename("Partial omega-squared" = "Omega2_partial")
omegasq_pwr[16, ] = NA # add omega-squared of 0 for residuals

anova_table_pwr = as.data.frame(anova(anova_pwr))

# Kable reports extremely small p-values as 0.000, while APA-7 requires them to be reported as <.001 . Let's transform the dataframe


anova_table_pwr = cbind(anova_table_pwr, omegasq_pwr) %>% 
  rename("p-value" = "Pr(>F)") 

anova_table_pwr$`p-value` = format.pval(anova_table_pwr$`p-value`, digits = 2, eps = .001)

options(knitr.kable.NA = '')
```

**ANOVA.** Aa 4 × 2 × 3 × 4 × 3 factorial Type I ANOVA was used to analyse the effect of the manipulated parameters (288 conditions in total) on statistical power. The results are reported in Table \ref{tab:tab_aov_pwr}.

Four main effect above the cut-off for the effect size were found: the effect of compliance ($\omega^{2}_p$ = `r round(anova_table_pwr[4, 6], 2)`), of missingness type ($\omega^{2}_p$ = `r round(anova_table_pwr[3, 6], 2)`), simulated fixed slope ($\omega^{2}_p$ = `r round(anova_table_pwr[5, 6], 2)`), and the effect of the number of timepoints per participant ($\omega^{2}_p$ = `r round(anova_table_pwr[2, 6], 2)`).

```{r tab_aov_pwr, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}

kable(anova_table_pwr, 
      format = "latex", 
      booktabs = TRUE,  
      digits = 2,
      caption = "ANOVA results, simulation A. Outcome: Power to detect the fixed slope") %>% 
  kable_styling(full_width = F)
```

## Simulation B 
